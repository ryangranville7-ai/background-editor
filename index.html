<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пакетный Редактор Фона на Nano Banana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Цвет фона дублируется здесь для надежности */
            background-color: #111827;
            color: #f3f4f6;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        .small-loader { width: 20px; height: 20px; border-width: 2px; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .custom-file-upload {
            border: 2px dashed #4b5563;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            cursor: pointer;
            text-align: center;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            width: 100%;
            height: 100%;
        }

        .custom-file-upload:hover {
            background-color: #1f2937;
            border-color: #6b7280;
        }

        input[type="file"] { display: none; }

        .glass-card {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
    </style>
</head>

<body class="antialiased" style="background-color: #111827;">
    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
             <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-blue-600">GammaMotors</h1>
             <p class="text-base sm:text-lg text-gray-400 mt-2">Приложение для быстрой замены фона на фотографиях ваших двигателей и не только!</p>
        </header>
        
        <main id="app-content" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8">
            <!-- Левая колонка: Управление -->
            <div class="lg:col-span-1 space-y-6">
                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4 text-white">1. Загрузите фото</h2>
                    <div class="flex gap-2">
                        <label for="image-upload" class="custom-file-upload flex-grow">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500 mb-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <span class="font-medium text-blue-400">Добавить фото</span>
                            <span class="mt-1 block text-xs text-gray-500">Выбрать из файлов</span>
                        </label>
                         <button id="camera-btn" class="flex-shrink-0 p-4 border-2 border-dashed border-gray-700 rounded-lg flex items-center justify-center hover:bg-gray-800/50 transition" title="Сделать фото с камеры">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                        </button>
                    </div>
                    <input id="image-upload" type="file" accept="image/png, image/jpeg, image/webp" multiple>
                </div>

                <div id="analysis-section" class="glass-card p-4 md:p-6 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg md:text-xl font-semibold text-white">✨ Анализ и Идеи</h2>
                        <div class="flex items-center gap-3">
                             <button id="refresh-ideas-btn" class="text-gray-400 hover:text-white transition flex items-center justify-center" title="Обновить идеи">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                            </button>
                            <div id="analysis-loader" class="loader small-loader hidden"></div>
                        </div>
                    </div>
                    <div id="analysis-content" class="hidden">
                        <h3 class="font-semibold text-blue-400">Анализ (по первому фото):</h3>
                        <p id="analysis-text" class="text-gray-300 mt-1 mb-4 text-sm"></p>
                        <h3 class="font-semibold text-blue-400">Идеи для фона:</h3>
                        <div id="suggestions-container" class="flex flex-wrap gap-2 mt-2"></div>
                    </div>
                </div>

                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4 text-white">2. Выберите фон и/или дайте инструкции</h2>
                     <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-gray-300 mb-2">Опишите фон или дайте инструкции</h3>
                            <textarea id="prompt-input" rows="3" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Например: 'поставь объект на гоночный трек на закате'"></textarea>
                        </div>
                         <div>
                            <h3 class="font-semibold text-gray-300 mb-2">Загрузите свой фон (необязательно)</h3>
                            <label for="background-upload" class="custom-file-upload !py-4">
                                <span class="font-medium text-blue-400">Выберите файл фона</span>
                            </label>
                            <input id="background-upload" type="file" accept="image/png, image/jpeg, image/webp">
                            <div id="background-preview-container" class="mt-4 relative hidden">
                                <img id="background-preview-image" src="" class="w-full rounded-lg">
                                <button id="remove-background-btn" class="absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-1 rounded-full transition flex items-center justify-center" title="Удалить фон">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="glass-card p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-semibold mb-4 text-white">3. Запустите процесс</h2>
                     <button id="generate-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/><path d="m9 11 3 3 3-3"/><path d="M12 14V6"/></svg>
                        ✨ Заменить фон
                     </button>
                </div>
            </div>

            <!-- Правая колонка: Результаты -->
            <div id="results-gallery" class="lg:col-span-2 space-y-4 min-h-[60vh]">
                 <div id="gallery-placeholder" class="h-full flex flex-col items-center justify-center text-center text-gray-500 border-2 border-dashed border-gray-700 rounded-lg p-8">
                     <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-9"/><path d="m10 15-3.12-3.12a2.83 2.83 0 0 0-4 0L2 12.88V20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-7.12l-.88-.88a2.83 2.83 0 0 0-4 0L14 15"/><path d="m22 4-3.12 3.12a2.83 2.83 0 0 1-4 0L14 6"/><path d="m16 2-3.12 3.12a2.83 2.83 0 0 0 0 4L14 14"/><circle cx="12" cy="12" r="10"/></svg>
                     <p class="mt-4 text-base md:text-lg">Результаты пакетной обработки</p>
                     <p class="text-sm">Загрузите одно или несколько изображений, чтобы начать</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Модальное окно для камеры -->
    <div id="camera-modal" class="fixed inset-0 bg-black/80 flex-col items-center justify-center p-4 hidden z-50">
        <video id="camera-stream" class="w-full max-w-3xl h-auto rounded-lg" autoplay playsinline></video>
        <div class="mt-4 flex gap-4">
            <button id="capture-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition">Сделать снимок</button>
            <button id="close-camera-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full transition">Закрыть</button>
        </div>
    </div>

    <!-- Модальное окно для просмотра изображения -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center p-4 hidden z-50 cursor-pointer">
        <img id="preview-image" src="" class="max-w-full max-h-full rounded-lg">
        <button id="close-preview-btn" class="absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition flex items-center justify-center" title="Закрыть">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
        </button>
    </div>


    <script>
        const imageUpload = document.getElementById('image-upload');
        const backgroundUpload = document.getElementById('background-upload');
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const resultsGallery = document.getElementById('results-gallery');
        const galleryPlaceholder = document.getElementById('gallery-placeholder');
        const backgroundPreviewContainer = document.getElementById('background-preview-container');
        const backgroundPreviewImage = document.getElementById('background-preview-image');
        const removeBackgroundBtn = document.getElementById('remove-background-btn');
        const analysisSection = document.getElementById('analysis-section');
        const analysisLoader = document.getElementById('analysis-loader');
        const analysisContent = document.getElementById('analysis-content');
        const analysisText = document.getElementById('analysis-text');
        const suggestionsContainer = document.getElementById('suggestions-container');
        const cameraBtn = document.getElementById('camera-btn');
        const cameraModal = document.getElementById('camera-modal');
        const cameraStream = document.getElementById('camera-stream');
        const captureBtn = document.getElementById('capture-btn');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const imagePreviewModal = document.getElementById('image-preview-modal');
        const previewImage = document.getElementById('preview-image');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const refreshIdeasBtn = document.getElementById('refresh-ideas-btn');

        const BROWSER_API_KEY = "AIzaSyCqbHUnLAXebrp7g3TEj68PGso5c4sUhy4";
        const GEMINI_API_KEY = BROWSER_API_KEY; // Используем ключ для браузера

        let imageFilesState = [];
        let customBackgroundBase64 = null;
        let currentStream = null;

        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        const compressAndBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const img = new Image();
                img.src = reader.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_DIM = 2048;
                    let { width, height } = img;
                    if (width > height) {
                        if (width > MAX_DIM) { height *= MAX_DIM / width; width = MAX_DIM; }
                    } else {
                        if (height > MAX_DIM) { width *= MAX_DIM / height; height = MAX_DIM; }
                    }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.95).split(',')[1]);
                }
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
        
        async function callGeminiAPI(payload, retries = 3, delay = 1000) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                       if (response.status === 403) {
                           throw new Error(`Ошибка доступа (403). Проверьте настройки API-ключа и убедитесь, что Generative Language API включен в проекте.`);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }
        
        function renderGallery() {
            if (imageFilesState.length === 0) {
                galleryPlaceholder.classList.remove('hidden');
                resultsGallery.innerHTML = '';
                resultsGallery.appendChild(galleryPlaceholder);
                generateButton.disabled = true;
                return;
            }
            
            galleryPlaceholder.classList.add('hidden');
            resultsGallery.innerHTML = '';

            imageFilesState.forEach((imgState) => {
                const card = document.createElement('div');
                card.className = 'glass-card p-4';

                const resultHtml = () => {
                    switch (imgState.status) {
                        case 'pending':
                            return `<div class="w-full aspect-square bg-gray-900/50 rounded-lg flex items-center justify-center text-gray-500 text-xs text-center p-2">Ожидает генерации</div>`;
                        case 'generating':
                            return `<div class="w-full aspect-square bg-gray-900/50 rounded-lg flex items-center justify-center"><div class="loader"></div></div>`;
                        case 'done':
                            return `
                                <img src="${imgState.resultSrc}" class="w-full h-full object-cover rounded-lg cursor-pointer view-image-btn">
                                <div class="absolute bottom-2 right-2 flex items-center gap-2">
                                    <button class="regenerate-btn bg-gray-800/60 hover:bg-gray-700/80 text-white p-2 rounded-full transition flex items-center justify-center" data-id="${imgState.id}" title="Повторить">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                                    </button>
                                    <a href="${imgState.resultSrc}" download="replaced_${imgState.id.split('-')[0] || 'image'}.png" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition duration-300 flex items-center justify-center" title="Скачать">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    </a>
                                </div>
                            `;
                        case 'error':
                             return `
                                <div class="w-full aspect-square bg-red-900/30 rounded-lg flex flex-col items-center justify-center text-red-400 text-xs text-center p-2">
                                    <span>${imgState.error}</span>
                                    <button class="regenerate-btn mt-2 bg-gray-700 hover:bg-gray-600 text-white py-1 px-3 rounded-full transition text-xs flex items-center justify-center" data-id="${imgState.id}">
                                        Повторить
                                    </button>
                                </div>
                            `;
                        default:
                            return '';
                    }
                };

                card.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative aspect-square">
                            <h3 class="absolute top-2 left-2 text-sm font-semibold text-white bg-black/40 px-2 py-1 rounded-md z-10">Оригинал</h3>
                            <img src="${imgState.originalSrc}" class="w-full h-full object-cover rounded-lg">
                            <button class="remove-image-btn absolute top-2 right-2 bg-black/50 hover:bg-black/70 text-white p-1 rounded-full transition z-10 flex items-center justify-center" data-id="${imgState.id}" title="Удалить фото">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div class="relative aspect-square">
                             <h3 class="absolute top-2 left-2 text-sm font-semibold text-white bg-black/40 px-2 py-1 rounded-md z-10">Результат</h3>
                             ${resultHtml()}
                        </div>
                    </div>
                `;
                resultsGallery.appendChild(card);
            });
            generateButton.disabled = false;
        }
        
        async function analyzeFirstImageAndSuggest(isRefresh = false) {
            if (imageFilesState.length === 0) return;

            analysisSection.classList.remove('hidden');
            analysisLoader.classList.remove('hidden');
            analysisContent.classList.add('hidden');
            refreshIdeasBtn.disabled = true;

            const firstImageBase64 = imageFilesState[0].base64;

            const promptText = isRefresh
                ? "Анализируй это изображение. Кратко опиши основной объект в 5-10 словах. Предложи 3 *новые и другие* креативные идеи для замены фона, которые бы хорошо сочетались с основным объектом. Ответ дай в формате чистого JSON без markdown: {\"analysis\": \"описание объекта\", \"suggestions\": [\"идея 1\", \"идея 2\", \"идея 3\"]}"
                : "Анализируй это изображение. Кратко опиши основной объект в 5-10 словах. Предложи 3 креативные идеи для замены фона, которые бы хорошо сочетались с основным объектом. Ответ дай в формате чистого JSON без markdown: {\"analysis\": \"описание объекта\", \"suggestions\": [\"идея 1\", \"идея 2\", \"идея 3\"]}";

            const payload = {
                contents: [{
                    parts: [
                        { text: promptText },
                        { inlineData: { mimeType: "image/jpeg", data: firstImageBase64 } }
                    ]
                }],
            };

            try {
                const result = await callGeminiAPI(payload);
                const textPart = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textPart) throw new Error("Не удалось получить анализ от API.");

                const jsonString = textPart.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(jsonString);

                analysisText.textContent = data.analysis;
                suggestionsContainer.innerHTML = '';
                data.suggestions.forEach(suggestion => {
                    const button = document.createElement('button');
                    button.textContent = suggestion;
                    button.className = 'bg-gray-700 hover:bg-gray-600 text-sm text-gray-200 font-medium py-1.5 px-3 rounded-full transition';
                    button.onclick = () => {
                        promptInput.value = suggestion;
                    };
                    suggestionsContainer.appendChild(button);
                });
                
                analysisContent.classList.remove('hidden');
            } catch (error) {
                console.error("API Error (Analysis):", error);
                analysisText.textContent = `Не удалось проанализировать: ${error.message}`;
                 analysisContent.classList.remove('hidden');
            } finally {
                analysisLoader.classList.add('hidden');
                refreshIdeasBtn.disabled = false;
            }
        }
        
        refreshIdeasBtn.addEventListener('click', () => analyzeFirstImageAndSuggest(true));

        async function addFilesToState(files) {
            const newFiles = Array.from(files).filter(file => {
                const fileId = file.name + '-' + file.lastModified;
                return !imageFilesState.some(state => state.id === fileId);
            });

            if (newFiles.length === 0) return;

            galleryPlaceholder.classList.add('hidden');
            
            const processingPromises = newFiles.map(async file => {
                const originalSrc = await fileToBase64(file);
                const compressedBase64 = await compressAndBase64(file);
                return {
                    id: file.name + '-' + file.lastModified,
                    originalSrc: originalSrc,
                    base64: compressedBase64,
                    status: 'pending',
                    resultSrc: null,
                    error: null,
                };
            });
            
            const newImageStates = await Promise.all(processingPromises);
            imageFilesState.push(...newImageStates);
        }

        imageUpload.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (!files.length) return;
            
            const wasEmpty = imageFilesState.length === 0;
            await addFilesToState(files);
            renderGallery();
            
            if (wasEmpty && imageFilesState.length > 0) {
                analyzeFirstImageAndSuggest(false);
            }
        });

        cameraBtn.addEventListener('click', async () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Камера не поддерживается вашим браузером.');
                return;
            }
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                cameraStream.srcObject = currentStream;
                cameraModal.classList.remove('hidden');
                cameraModal.classList.add('flex');
            } catch (err) {
                console.error("Error accessing camera:", err);
                alert('Не удалось получить доступ к камере. Проверьте разрешения.');
            }
        });

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
        }

        closeCameraBtn.addEventListener('click', stopCamera);

        captureBtn.addEventListener('click', async () => {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStream.videoWidth;
            canvas.height = cameraStream.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
            
            stopCamera();

            const wasEmpty = imageFilesState.length === 0;

            canvas.toBlob(async (blob) => {
                const fileName = `camera-${Date.now()}.jpg`;
                const file = new File([blob], fileName, { type: 'image/jpeg', lastModified: Date.now() });
                await addFilesToState([file]); 
                renderGallery();
                if (wasEmpty && imageFilesState.length > 0) {
                    analyzeFirstImageAndSuggest(false);
                }
            }, 'image/jpeg', 0.95);
        });

        resultsGallery.addEventListener('click', (event) => {
            const viewBtn = event.target.closest('.view-image-btn');
            if (viewBtn) {
                previewImage.src = viewBtn.src;
                imagePreviewModal.classList.remove('hidden');
            }
        });
        
        function closePreviewModal() {
            imagePreviewModal.classList.add('hidden');
            previewImage.src = '';
        }

        closePreviewBtn.addEventListener('click', closePreviewModal);
        imagePreviewModal.addEventListener('click', (event) => {
            if(event.target === imagePreviewModal) {
                closePreviewModal();
            }
        });


        backgroundUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                customBackgroundBase64 = null;
                backgroundPreviewContainer.classList.add('hidden');
                return;
            };

            const previewUrl = URL.createObjectURL(file);
            backgroundPreviewImage.src = previewUrl;
            backgroundPreviewContainer.classList.remove('hidden');

            customBackgroundBase64 = await compressAndBase64(file);
        });

        removeBackgroundBtn.addEventListener('click', () => {
            customBackgroundBase64 = null;
            backgroundPreviewContainer.classList.add('hidden');
            backgroundPreviewImage.src = '';
            backgroundUpload.value = '';
        });

        resultsGallery.addEventListener('click', async (event) => {
            const removeBtn = event.target.closest('.remove-image-btn');
            if (removeBtn) {
                const imageIdToRemove = removeBtn.dataset.id;
                const wasFirstImage = imageFilesState.length > 0 && imageFilesState[0].id === imageIdToRemove;

                imageFilesState = imageFilesState.filter(img => img.id !== imageIdToRemove);

                renderGallery();

                if (imageFilesState.length === 0) {
                    analysisSection.classList.add('hidden');
                } else if (wasFirstImage) {
                    analyzeFirstImageAndSuggest(false);
                }
                return;
            }

            const regenerateBtn = event.target.closest('.regenerate-btn');
            if (regenerateBtn) {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt && !customBackgroundBase64) {
                    alert('Пожалуйста, опишите фон или загрузите свой, чтобы повторить генерацию.');
                    return;
                }

                const imageIdToRegenerate = regenerateBtn.dataset.id;
                const imgState = imageFilesState.find(img => img.id === imageIdToRegenerate);
                
                if (imgState) {
                    imgState.status = 'generating';
                    imgState.error = null;
                    imgState.resultSrc = null;
                    renderGallery();
                    
                    await generateSingleImage(imgState, userPrompt);
                }
            }
        });


        generateButton.addEventListener('click', async () => {
            const userPrompt = promptInput.value.trim();

            if (!userPrompt && !customBackgroundBase64) {
                alert('Пожалуйста, опишите фон или загрузите свой.');
                return;
            }

            generateButton.disabled = true;

            imageFilesState.forEach(state => {
                state.status = 'pending';
                state.resultSrc = null;
                state.error = null;
            });
            
            for (const imgState of imageFilesState) {
                imgState.status = 'generating';
                renderGallery();
                await generateSingleImage(imgState, userPrompt);
                await new Promise(res => setTimeout(res, 1500)); 
            }
            
            generateButton.disabled = false;
        });

        async function generateSingleImage(imgState, userPrompt) {
            try {
                const parts = [];
                
                if (customBackgroundBase64 && userPrompt) {
                    parts.push({ text: `Это задача по редактированию изображений. Возьми главный объект с первого изображения и помести его на второе изображение, которое будет новым фоном. Используй эту инструкцию для расположения и стиля: "${userPrompt}". Итоговое изображение должно быть фотореалистичным и цельным.` });
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: imgState.base64 } });
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: customBackgroundBase64 } });
                } else if (customBackgroundBase64) {
                    parts.push({ text: "Это задача по редактированию изображений. Возьми главный объект с первого изображения и помести его на второе изображение, которое будет новым фоном. Впиши объект в новый фон гармонично и фотореалистично." });
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: imgState.base64 } });
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: customBackgroundBase64 } });
                } else if (userPrompt) {
                    parts.push({ text: `Это задача по редактированию изображений. Замени фон на этом изображении, основываясь на следующем описании: "${userPrompt}". Сохрани главный объект исходного изображения. Новый фон должен быть фотореалистичным и хорошо вписанным.` });
                    parts.push({ inlineData: { mimeType: "image/jpeg", data: imgState.base64 } });
                }

                const payload = {
                    contents: [{ parts }],
                    generationConfig: { responseModalities: ['IMAGE'] }
                };

                const result = await callGeminiAPI(payload);
                const candidate = result?.candidates?.[0];

                if (result.promptFeedback && result.promptFeedback.blockReason) {
                     throw new Error(`Заблокировано: ${result.promptFeedback.blockReason}`);
                }
                
                if (!candidate) {
                    throw new Error("API вернул пустой ответ.");
                }
                
                const base64Data = candidate.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    imgState.status = 'done';
                    imgState.resultSrc = `data:image/png;base64,${base64Data}`;
                } else {
                    const finishReason = candidate.finishReason;
                    const textPart = candidate.content?.parts?.find(p => p.text)?.text;
                    
                    let errorMessage = "API не вернул изображение.";
                    if (finishReason && finishReason !== 'STOP') {
                        errorMessage += ` Причина: ${finishReason}.`;
                    }
                    if (textPart) {
                        errorMessage += ` Ответ API: "${textPart}"`;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error(`Error for ${imgState.id}:`, error);
                imgState.status = 'error';
                imgState.error = error.message.substring(0, 100) + (error.message.length > 100 ? '...' : '');
            }
            renderGallery();
        }

    </script>
</body>
</html>

